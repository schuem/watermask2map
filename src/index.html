<!DOCTYPE html> 
<html>
 <meta charset="utf-8"> 
<head> 
  <title>sar2watermask</title> 
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.4/ol.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-beta.3/css/bootstrap.min.css" type="text/css">
  <link rel="stylesheet" href="style.css" type="text/css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.6.4/ol.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head> 
<body>

<div id="js-map" class="map"></div>
<!-- <div class="pane">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">Feature Information</h3>
        </div>
        <div id="js-feature-info" class="feature-info"></div>
    </div>
</div> -->
<div id="popup" class="popup">
  <a href="#" id="popup-closer" class="popup-closer"></a>
  <div class="child" id="popup-content-map"></div>
  <div class="child" id="popup-content-table"></div>
</div>

<script>
  function createPopupTable(data) {
    var eTable = "<table class='table table-bordered table-condensed'> \
                  <caption> Data for Cogerh ID "+data[0].id_cogerh+"</caption> \
                  <thead><tr> \
                    <th>Ingestion Time</th> \
                    <th>Area</th> \
                    <th>Source</th> \
                  </thead></tr> \
                  <tbody>";
    $.each(data, function(index, row){
      eTable += "<tr>";
      eTable += "<td>"+row['ingestion_time']+"</td>";
      eTable += "<td>"+row['area']+"</td>";
      eTable += "<td>"+row['name']+"</td>";
      eTable += "</tr>";
    });
    eTable +="</tbody></table>";
    popupTable.innerHTML = eTable;
  }

  function createPopupMap(data) {
    // width and height of whole visualization
    var width = 200px,
        height = 200px;

    // create svg inside div
    var svg = d3.select(popupMap)
                .append("svg")
                  .attr("width", width)
                  .attr("height", height);
  }

  /**
 * Elements that make up the popup.
 */
var container = document.getElementById('popup');
var popupTable = document.getElementById('popup-content-table');
var popupMap = document.getElementById('popup-content-map')
var closer = document.getElementById('popup-closer');
/**
 * Create an overlay to anchor the popup to the map.
 */
var overlay = new ol.Overlay({
  element: container,
  autoPan: true,
  autoPanAnimation: {
    duration: 250
  }
});
/**
 * Add a click handler to hide the popup.
 * @return {boolean} Don't follow the href.
 */
closer.onclick = function() {
  overlay.setPosition(undefined);
  closer.blur();
  return false;
};


var osmTiles = new ol.layer.Tile({ 
	name: 'osm',
  source: new ol.source.OSM() 
});

var watermaskSource = new ol.source.TileWMS({ 
  url: 'http://141.89.96.184/latestwms?', 
  params: {LAYERS: 'watermask', TILED: true}, 
  ratio: 1, 
  serverType: 'mapserver' 
});

var watermaskTiles = new ol.layer.Tile({
	name: 'watermask',
	source: watermaskSource,
 	opacity: 0.7 
});

var view = new ol.View({ 
  projection: 'EPSG:4326', 
  center: [-39, -5], 
  zoom: 7,
  minZoom: 7 
 });

var map = new ol.Map({ 
	layers: [osmTiles, watermaskTiles], 
	target: 'js-map', 
	view: view,
  overlays: [overlay]
});



var $featureInfo = $('#js-feature-info');
var data;
map.on('singleclick', function(event) {
  var coordinate = event.coordinate;
  var url = watermaskSource.getGetFeatureInfoUrl(
    coordinate,
    map.getView().getResolution(),
    map.getView().getProjection(),
    {INFO_FORMAT: 'text/html'}
  );
  // console.log(url)

  $.ajax({
    type: 'GET',
    url: url,
    success: function(response) {
      // $featureInfo.html(response.match(/<body>([\s\S]+)<\/body>/)[1]);
      // $featureInfo.find('table').addClass('table table-bordered table-condensed');
      // $cogerid = $featureInfo.find(".id_cogerh").html();
      $cogerid = $(response).find(".id_cogerh").html();
    }
  }).done(function() {
    $.ajax({
      type: 'GET',
      url: 'test.php',
      data: {id: $cogerid},
      success: function(response) {
        createPopupTable(JSON.parse(response));

        overlay.setPosition(coordinate);
      }
    });
  });
});

map.on('pointermove', function(e) {
	if (e.dragging) {
	  return;
	}
	var pixel = map.getEventPixel(e.originalEvent);
	var hit = map.forEachLayerAtPixel(pixel, function(layer) {
	  return layer.get('name') === 'watermask';
	});
	map.getTargetElement().style.cursor = hit ? 'pointer' : '';
});

map.getView().on('change:resolution', function(e) {
  console.log(view.getZoom());
});



</script>

</body> 
</html>